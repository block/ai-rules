name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Check code formatting
        run: |
          source bin/activate-hermit
          echo "Checking code formatting..."
          cargo fmt --check

  clippy:
    name: Clippy Lints
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Run Clippy
        run: |
          source bin/activate-hermit
          ./scripts/clippy-check.sh

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Run tests
        run: |
          source bin/activate-hermit
          echo "Running tests..."
          cargo test --verbose

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Install cargo-audit
        run: |
          source bin/activate-hermit
          echo "Installing cargo-audit..."
          cargo install cargo-audit

      - name: Run security audit
        run: |
          source bin/activate-hermit
          echo "Running security audit..."
          cargo audit

  test-release:
    name: Test Build
    runs-on: ubuntu-latest
    needs: [fmt, clippy, test, audit]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Build release
        run: |
          source bin/activate-hermit
          cargo build --release --verbose
